{% extends 'Service Provider folder/base_provider.html' %}

{% block content %}
<div class="container-fluid h-100">
	<div class="row justify-content-center h-100">
		<div class="col-md-10 col-xl-8 chat h-100">
			<div class="card-glass position-relative" style="height: 80vh; display: flex; flex-direction: column;">

				<!-- Chat Header -->
				<div class="p-3 border-bottom d-flex justify-content-between align-items-center"
					style="background: rgba(255, 255, 255, 0.05);">
					<div class="d-flex align-items-center">
						<div class="position-relative">
							<img src="/static/hometemp/img/user.jpg" class="rounded-circle border border-2 border-white"
								style="width: 50px; height: 50px; object-fit: cover;">
							<span class="position-absolute bottom-0 end-0 bg-success border border-white rounded-circle"
								style="width: 12px; height: 12px;"></span>
						</div>
						<div class="ms-3 text-white">
							<h5 class="mb-0 fw-bold">Chat</h5>
							<small class="text-white-50">Active Now</small>
						</div>
					</div>
				</div>

				<!-- Chat Body -->
				<div id="chat-body" class="card-body msg_card_body overflow-auto p-4" style="flex: 1;">
					<!-- Messages will be loaded here via AJAX -->
					<div class="text-center text-muted mt-5">
						<i class="fas fa-spinner fa-spin fa-2x"></i>
						<p class="mt-2">Loading messages...</p>
					</div>
				</div>

				<!-- Chat Footer -->
				<div class="card-footer p-3 border-top" style="background: rgba(255, 255, 255, 0.05);">
					<div class="input-group">
						<input type="text" id="textfield" class="glass-input form-control border-end-0"
							placeholder="Type your message..." style="height: 50px;">
						<button id="send-btn" class="glass-btn bg-primary border-0 rounded-end"
							style="height: 50px; padding: 0 25px;">
							<i class="fas fa-paper-plane"></i>
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<style>
	/* Chat Bubble Styles */
	.msg_cotainer {
		background: rgba(255, 255, 255, 0.2);
		padding: 10px 15px;
		border-radius: 20px 20px 20px 0;
		color: white;
		position: relative;
		max-width: 70%;
		backdrop-filter: blur(5px);
		box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
	}

	.msg_cotainer_send {
		background: var(--secondary-color);
		padding: 10px 15px;
		border-radius: 20px 20px 0 20px;
		color: white;
		position: relative;
		max-width: 70%;
		box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
	}

	.img_cont_msg {
		width: 40px;
		height: 40px;
	}

	.user_img_msg {
		width: 100%;
		height: 100%;
		object-fit: cover;
	}

	/* Custom Scrollbar for Chat */
	.msg_card_body::-webkit-scrollbar {
		width: 6px;
	}

	.msg_card_body::-webkit-scrollbar-track {
		background: rgba(255, 255, 255, 0.05);
	}

	.msg_card_body::-webkit-scrollbar-thumb {
		background: rgba(255, 255, 255, 0.2);
		border-radius: 10px;
	}
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
	const chatBody = document.getElementById('chat-body');
	let isScrolledToBottom = true;

	// Monitor scroll position to prevent auto-scroll if user is reading up
	chatBody.addEventListener('scroll', () => {
		isScrolledToBottom = chatBody.scrollHeight - chatBody.scrollTop === chatBody.clientHeight;
	});

	function scrollToBottom() {
		chatBody.scrollTop = chatBody.scrollHeight;
	}

	function loadChat() {
		$.ajax({
			url: "/provider_chat_view/",
			type: "GET",
			dataType: "json",
			success: function (dat) {
				const data = dat.data;
				const toId = dat.toid;
				const currentContent = $("#chat-body").html();

				let newContent = "";

				if (data.length === 0) {
					newContent = '<div class="text-center text-muted mt-5"><i class="fas fa-comments fa-3x mb-3"></i><p>No messages yet. Start the conversation!</p></div>';
				} else {
					for (let i = 0; i < data.length; i++) {
						const message = data[i].message;
						const from = data[i].from;
						const date = data[i].date; // Assuming date is available

						if (from != toId) {
							// Message from me (Sent)
							newContent += `
                                <div class="d-flex justify-content-end mb-4">
                                    <div class="msg_cotainer_send">
                                        ${message}
                                        <!-- <span class="msg_time_send">${date}</span> -->
                                    </div>
                                </div>`;
						} else {
							// Message from user (Received)
							newContent += `
                                <div class="d-flex justify-content-start mb-4">
                                    <div class="img_cont_msg me-2">
                                        <img src="/static/hometemp/img/user.jpg" class="rounded-circle user_img_msg border border-white">
                                    </div>
                                    <div class="msg_cotainer">
                                        ${message}
                                        <!-- <span class="msg_time">${date}</span> -->
                                    </div>
                                </div>`;
						}
					}
				}

				// Only update DOM if content changed to avoid flickering logic (simplified here)
				// ideally we'd diff, but replacing is okay for now if not too frequent
				$("#chat-body").html(newContent);

				if (isScrolledToBottom) {
					scrollToBottom();
				}
			},
			error: function (err) {
				console.error("Error loading chat:", err);
			}
		});
	}

	// Send Message
	$("#send-btn").click(sendMessage);
	$("#textfield").keypress(function (e) {
		if (e.which == 13) sendMessage();
	});

	function sendMessage() {
		const msg = $("#textfield").val();
		if (msg.trim() === "") return;

		$.ajax({
			url: "/provider_chat_send/" + encodeURIComponent(msg),
			type: "GET",
			dataType: "json",
			success: function (dat) {
				$("#textfield").val("");
				loadChat();
				setTimeout(scrollToBottom, 100); // Ensure scroll after load
			}
		});
	}

	// Auto-refresh every 2 seconds
	setInterval(loadChat, 2000);

	// Initial Load
	loadChat();
</script>
{% endblock %}