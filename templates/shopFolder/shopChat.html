{% extends 'shopFolder/base_shop.html' %}

{% block content %}
<div class="container-fluid h-100">
	<div class="row justify-content-center h-100">
		<div class="col-md-8 col-xl-8 chat">
			<div class="card-glass" style="height: 80vh; display: flex; flex-direction: column; padding: 0;">

				<!-- Chat Header -->
				<div class="p-3 border-bottom border-secondary d-flex justify-content-between align-items-center"
					style="background: rgba(255,255,255,0.05);">
					<div class="d-flex align-items-center">
						<div class="position-relative">
							<img src="/static/hometemp/img/user.jpg" id="chatUserImg"
								class="rounded-circle border border-2 border-primary"
								style="width: 50px; height: 50px; object-fit: cover;">
							<span
								class="position-absolute bottom-0 end-0 bg-success rounded-circle border border-2 border-dark"
								style="width: 12px; height: 12px;"></span>
						</div>
						<div class="ms-3 text-white">
							<h5 class="mb-0" id="chatUserName">Customer Chat</h5>
							<small class="text-muted">Online</small>
						</div>
					</div>
				</div>

				<!-- Chat Body -->
				<div class="card-body msg_card_body" id="chatContainer"
					style="overflow-y: auto; flex: 1; padding: 20px;">
					<!-- Messages will be loaded here via AJAX -->
					<div class="text-center text-muted mt-5">
						<i class="fas fa-spinner fa-spin fa-2x"></i>
						<p class="mt-2">Loading conversation...</p>
					</div>
				</div>

				<!-- Chat Footer -->
				<div class="p-3 border-top border-secondary" style="background: rgba(255,255,255,0.05);">
					<div class="input-group">
						<input type="text" id="textfield" class="form-control glass-input border-0"
							placeholder="Type your message..." style="height: 50px;">
						<button class="btn btn-primary px-4" id="sendBtn">
							<i class="fas fa-paper-plane"></i>
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<style>
	.msg_cotainer {
		background-color: rgba(255, 255, 255, 0.2);
		padding: 10px 15px;
		border-radius: 20px 20px 20px 0;
		color: white;
		position: relative;
		border: 1px solid rgba(255, 255, 255, 0.1);
		max-width: 75%;
		word-wrap: break-word;
	}

	.msg_cotainer_send {
		background-color: var(--primary-color);
		padding: 10px 15px;
		border-radius: 20px 20px 0 20px;
		color: white;
		position: relative;
		border: 1px solid rgba(255, 255, 255, 0.1);
		max-width: 75%;
		word-wrap: break-word;
	}
</style>

<script>
	const toId = "{{ toid }}"; // Context variable from Django view

	function loadChat() {
		$.ajax({
			url: "/shop_chat_view/", // Ensure this URL matches your urls.py for fetching chat
			type: "GET",
			// If your view needs the other user's ID passed in query:
			data: { id: toId },
			dataType: "json",
			success: function (response) {
				$("#chatContainer").empty();

				// Update header info if provided in response
				if (response.name) $("#chatUserName").text(response.name);
				if (response.photo) $("#chatUserImg").attr("src", response.photo);

				const data = response.data;
				// 'toid' might be passed in response or we use the template var 'toId'
				// Assuming data structure: [{message: "hi", from: 123}, ...]

				if (data.length === 0) {
					$("#chatContainer").html('<div class="text-center text-muted mt-5">No messages yet. Start the conversation!</div>');
					return;
				}

				data.forEach(msg => {
					if (String(msg.from) !== String(toId)) {
						// Message from ME (Shop Owner) - assuming 'toId' is the customer
						// Wait, logic check: 'from' == 'toId' means it's from the customer.
						// So 'from' != 'toId' means it is SENT by me. 
						// *However, typically 'toId' is the person I'm chatting WITH.*
						// Let's assume the standard: If msg.from == current_user_id (me), it's sent.
						// But we often don't have my ID in JS easily.
						// Alternative common pattern in these legacy chat apps:
						// 'from' ID is compared to the 'toId' (partner).

						// If message `from` matches the partner's ID (`toId`), it is RECEIVED.
						// Otherwise it is SENT.

						// Re-reading original code logic:
						// if (from != user_lid) { append SENT style } else { append RECEIVED style }
						// where user_lid was dat["toid"].

						// So if message is NOT from the person I'm talking to, it must be from me.

						$("#chatContainer").append(`
                            <div class="d-flex justify-content-end mb-3">
                                <div class="msg_cotainer_send">${msg.message}</div>
                            </div>
                        `);
					} else {
						// Message from THEM (Customer)
						$("#chatContainer").append(`
                            <div class="d-flex justify-content-start mb-3">
                                <div class="msg_cotainer">${msg.message}</div>
                            </div>
                        `);
					}
				});

				// Scroll to bottom
				const chatDiv = document.getElementById("chatContainer");
				chatDiv.scrollTop = chatDiv.scrollHeight;
			},
			error: function (err) {
				console.error("Chat load error:", err);
			}
		});
	}

	$("#sendBtn").click(function () {
		const msg = $("#textfield").val();
		if (msg.trim() === "") return;

		// Use the new URL structure if applicable, or keep standard
		// Original: /shop_chat_send/<msg> or /fit_chat_send/<msg>
		// We'll trust the URL set in the original file logic or similar
		// Let's stick to a robust URL pattern. 
		// Assuming /shop_chat_send/<msg> based on previous file viewing, though sometimes it's /shop_chat_send/<msg>/<id>
		// The original code had: url: "/shop_chat_send/" + encodeURIComponent(msg) (commented out?) or typical pattern.

		let sendUrl = `/shop_chat_send/${encodeURIComponent(msg)}`;
		// If we need to pass ID explicitly: `/shop_chat_send/${encodeURIComponent(msg)}/${toId}`
		// I will assume the view handles the session "to_id" or similar as per typical setup in this project.

		$.ajax({
			url: sendUrl,
			type: "GET",
			dataType: "json",
			success: function (rem) {
				$("#textfield").val("");
				loadChat();
			},
			error: function (err) {
				console.error("Send error:", err);
			}
		});
	});

	// Send on Enter key
	$("#textfield").on('keypress', function (e) {
		if (e.which === 13) {
			$("#sendBtn").click();
		}
	});

	$(document).ready(function () {
		loadChat();
		setInterval(loadChat, 2000); // 2 second refresh
	});
</script>
{% endblock %}