{% extends 'fitnessFolder/base_fitness.html' %}

{% block content %}
<div class="container-fluid">

    <!-- Stats Row -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card-glass text-center p-3">
                <h6 class="text-white-50">Total Reviews</h6>
                <h2 class="mb-0 text-white">{{ data|length }}</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card-glass text-center p-3">
                <h6 class="text-white-50">Avg Rating</h6>
                <h2 class="mb-0 text-warning" id="avgRating">-</h2>
            </div>
        </div>
    </div>

    <div class="card-glass">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="mb-0"><i class="fas fa-star me-2"></i>User Reviews</h3>
            <div class="d-flex gap-2">
                <select class="glass-input form-select w-auto" id="ratingFilter">
                    <option value="">All Ratings</option>
                    <option value="5">5 Stars</option>
                    <option value="4">4 Stars</option>
                    <option value="3">3 Stars</option>
                </select>
                <input type="text" id="searchInput" class="glass-input form-control" placeholder="Search reviews...">
            </div>
        </div>

        <div class="table-responsive">
            <table class="table text-white align-middle" id="dataTable">
                <thead>
                    <tr style="border-bottom: 1px solid var(--glass-border);">
                        <th>Date</th>
                        <th>User</th>
                        <th>Service</th>
                        <th>Rating</th>
                        <th style="width: 40%">Review</th>
                    </tr>
                </thead>
                <tbody>
                    {% for i in data %}
                    <tr data-rating="{{ i.Rating }}" style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <td class="text-white-50 small">{{ i.Date }}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-circle me-2 bg-primary text-white d-flex align-items-center justify-content-center"
                                    style="width: 35px; height: 35px; border-radius: 50%;">
                                    {{ i.USER.Name|slice:":1" }}
                                </div>
                                <div>
                                    <div class="fw-bold">{{ i.USER.Name }}</div>
                                    <small class="text-white-50">{{ i.USER.Email }}</small>
                                </div>
                            </div>
                        </td>
                        <td class="text-info">{{ i.SERVICE.Servicename }}</td>
                        <td>
                            <div class="text-warning">
                                {% for star in "12345" %}
                                {% if forloop.counter <= i.Rating %} <i class="fas fa-star"></i>
                                    {% else %}
                                    <i class="far fa-star text-white-50"></i>
                                    {% endif %}
                                    {% endfor %}
                            </div>
                        </td>
                        <td class="fst-italic text-white-50">"{{ i.Review }}"</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center py-5 text-muted">No reviews found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function filterTable() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const rating = document.getElementById('ratingFilter').value;
        const rows = document.querySelectorAll('#dataTable tbody tr');
        let totalRating = 0;
        let count = 0;

        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const rowRating = row.getAttribute('data-rating');

            const matchSearch = text.includes(search);
            const matchRating = rating === '' || rowRating === rating;

            if (matchSearch && matchRating) {
                row.style.display = '';
                totalRating += parseInt(rowRating);
                count++;
            } else {
                row.style.display = 'none';
            }
        });

        if (count > 0) {
            document.getElementById('avgRating').textContent = (totalRating / count).toFixed(1);
        }
    }

    document.getElementById('searchInput').addEventListener('keyup', filterTable);
    document.getElementById('ratingFilter').addEventListener('change', filterTable);

    // Init status
    filterTable(); 
</script>
{% endblock %}