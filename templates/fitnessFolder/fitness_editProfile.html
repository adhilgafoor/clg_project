{% extends 'fitnessFolder/main_home_page.html' %}
{% load static %}

{% block body %}
<div class="container py-5" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); min-height: 100vh;">
    <div class="row justify-content-center">
        <div class="col-lg-7 col-md-9">

            <!-- Header -->
            <div class="text-center mb-5">
                <h1 class="display-5 fw-bold" style="color: #0069d9;">
                    Edit Business Profile
                </h1>
                <p class="text-muted fs-5">Keep your business information up to date</p>
            </div>

            <!-- Form Card -->
            <div class="card border-0 shadow-lg rounded-4" style="background: white; overflow: hidden;">
                <div class="card-header text-white py-4 text-center" style="background: linear-gradient(135deg, #0069d9, #0077cc);">
                    <h4 class="mb-0">Update Your Details</h4>
                </div>

                <div class="card-body p-5">
                    <form method="POST" enctype="multipart/form-data">
                        {% csrf_token %}

                        <!-- Name, Email, Phone -->
                        <div class="row g-4 mb-4">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold" style="color: #0069d9;">Business Name <span class="text-danger">*</span></label>
                                <input type="text" name="name" value="{{ data.Name|default:'' }}" class="form-control form-control-lg" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold" style="color: #0069d9;">Email Address <span class="text-danger">*</span></label>
                                <input type="email" name="email" value="{{ data.Email|default:'' }}" class="form-control form-control-lg" required>
                            </div>
                        </div>

                        <div class="row g-4 mb-4">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold" style="color: #0069d9;">Phone Number <span class="text-danger">*</span></label>
                                <input type="tel" name="phone" value="{{ data.Phone|default:'' }}" class="form-control form-control-lg" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold" style="color: #0069d9;">Business Type</label>
                                <select name="type" class="form-select form-select-lg">
                                    <option value="service provider" {% if data.Type == 'service provider' %}selected{% endif %}>Service Provider</option>
                                    <option value="shop" {% if data.Type == 'shop' %}selected{% endif %}>Shop / Retail</option>
                                    <option value="fitness" {% if data.Type == 'fitness' %}selected{% endif %}>Fitness Center</option>
                                </select>
                            </div>
                        </div>

                        <!-- Location Section -->
                        <div class="p-4 rounded-3 mb-4" style="background: #f0f9ff; border: 2px dashed #81d4fa;">
                            <h5 class="fw-bold mb-3" style="color: #0069d9;">
                                Location Details
                            </h5>

                            <div class="row g-4">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Place / Area <span class="text-danger">*</span></label>
                                    <input type="text" id="place" name="place" value="{{ data.Place|default:'' }}" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">District <span class="text-danger">*</span></label>
                                    <input type="text" id="district" name="dict" value="{{ data.District|default:'' }}" class="form-control" required>
                                </div>
                            </div>

                            <div class="row g-4 mt-2">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">PIN Code <span class="text-danger">*</span></label>
                                    <input type="text" name="pin" value="{{ data.Pin|default:'' }}" class="form-control" required>
                                </div>
                            </div>

                            <!-- Location Buttons -->
                            <div class="mt-4 text-center">
                                <button type="button" onclick="getLocationFromPlace()" class="btn btn-outline-primary btn-lg px-4 me-3">
                                    Fetch Coordinates from Place
                                </button>
                                <button type="button" onclick="getCurrentLocation()" class="btn btn-primary btn-lg px-4">
                                    Use My Current Location
                                </button>
                            </div>

                            <!-- Coordinates -->
                            <div class="row g-4 mt-4">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Latitude <span class="text-danger">*</span></label>
                                    <input type="text" id="lat" name="lat" value="{{ data.latitude|default:'' }}" class="form-control" required readonly style="background: #e3f2fd;">
                                    <small class="text-success d-block mt-2" id="lat-status">Auto-filled if location fetched</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Longitude <span class="text-danger">*</span></label>
                                    <input type="text" id="long" name="longii" value="{{ data.longitude|default:'' }}" class="form-control" required readonly style="background: #e3f2fd;">
                                    <small class="text-success d-block mt-2" id="long-status">Auto-filled if location fetched</small>
                                </div>
                            </div>
                        </div>
                        </div>

                        <!-- Documents -->
                        <h5 class="fw-bold mb-4 mt-5" style="color: #0069d9;">
                            Update Documents
                        </h5>

                        <div class="row g-4">
                            <!-- Current Business Photo -->
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Current Business Photo</label>
                                {% if data.Photo.url %}
                                    <div class="text-center">
                                        <img src="{{ data.Photo.url }}" class="img-fluid rounded-3 shadow mb-3" style="max-height: 100px; object-fit: cover;">
                                        <br>
                                        <a href="{{ data.Photo.url }}" target="_blank" class="btn btn-sm btn-outline-primary mt-2">
                                            View Full Size
                                        </a>
                                    </div>
                                {% else %}
                                    <p class="text-muted text-center">No photo uploaded</p>
                                {% endif %}
                                <label class="form-label fw-semibold mt-3">Upload New Photo</label>
                                <input type="file" name="photo" class="form-control" accept=".jpg,.jpeg,.png">
                            </div>

                            <!-- Current Proof Document -->
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Current Proof Document</label>
                                {% if data.Proof.url %}
                                    <div class="text-center">
                                        <img src="{{ data.Proof.url }}" class="img-fluid rounded-3 shadow mb-3" style="max-height: 100px; object-fit: cover;">
                                        <br>
                                        <a href="{{ data.Proof.url }}" target="_blank" class="btn btn-sm btn-outline-primary mt-2">
                                            View Document
                                        </a>
                                    </div>
                                {% else %}
                                    <p class="text-muted text-center">No document uploaded</p>
                                {% endif %}
                                <label class="form-label fw-semibold mt-3">Upload New Proof</label>
                                <input type="file" name="proof" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="text-center mt-5">
                            <button type="submit" class="btn btn-lg px-5 py-4 fw-bold shadow"
                                    style="background: linear-gradient(135deg, #0069d9, #0077cc); color: white; border-radius: 50px; font-size: 18px; min-width: 280px;">
                                Update Profile
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Back Link -->

        </div>
    </div>
</div>

<!-- Font Awesome & Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>
<script>
    async function getLocationFromPlace() {
        const place = document.getElementById('place').value.trim();
        const district = document.getElementById('district').value.trim();

        if (!place || !district) {
            alert("Please enter both Place and District!");
            return;
        }

        const query = encodeURIComponent(`${place}, ${district}, Kerala, India`);
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=1`;

        try {
            const response = await fetch(url);
            const data = await response.json();

            if (data && data.length > 0) {
                const lat = parseFloat(data[0].lat).toFixed(6);
                const lon = parseFloat(data[0].lon).toFixed(6);

                document.getElementById('lat').value = lat;
                document.getElementById('long').value = lon;
                document.getElementById('lat-status').textContent = `Lat: ${lat}`;
                document.getElementById('long-status').textContent = `Long: ${lon}`;

                alert("Location fetched successfully!");
            } else {
                alert("Location not found. Please check spelling.");
            }
        } catch (err) {
            alert("Error fetching location. Check internet.");
        }
    }

    function getCurrentLocation() {
        if (!navigator.geolocation) {
            alert("Geolocation not supported");
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (pos) => {
                const lat = pos.coords.latitude.toFixed(6);
                const lon = pos.coords.longitude.toFixed(6);

                document.getElementById('lat').value = lat;
                document.getElementById('long').value = lon;
                document.getElementById('lat-status').textContent = `Lat: ${lat}`;
                document.getElementById('long-status').textContent = `Long: ${lon}`;

                alert("Current location applied!");
            },
            () => alert("Location access denied")
        );
    }
</script>

<style>
    .form-control:focus {
        border-color: #0069d9 !important;
        box-shadow: 0 0 0 4px rgba(0,105,255,0.15) !important;
    }
    .btn:hover {
        transform: translateY(-2px);
    }
</style>
{% endblock %}