{% extends 'fitnessFolder/base_fitness.html' %}

{% block content %}
<div class="container-fluid h-100">
	<div class="row h-100 justify-content-center">
		<div class="col-md-8 chat-container" style="height: calc(100vh - 120px);">
			<div class="card-glass h-100 d-flex flex-column p-0 overflow-hidden">
				<!-- Chat Header -->
				<div
					class="p-3 border-bottom border-light border-opacity-10 d-flex align-items-center bg-dark bg-opacity-25">
					<div class="position-relative me-3">
						<img src="https://ui-avatars.com/api/?name=User&background=random"
							class="rounded-circle border border-2 border-primary" width="50" height="50"
							id="chatUserImg">
						<span
							class="position-absolute bottom-0 end-0 p-1 bg-success border border-light rounded-circle"></span>
					</div>
					<div>
						<h5 class="mb-0 fw-bold text-white" id="chatUserName">Chat</h5>
						<small class="text-white-50">Online</small>
					</div>
				</div>

				<!-- Chat Body -->
				<div class="flex-grow-1 p-4 overflow-auto" id="msgBody" style="background: rgba(0,0,0,0.1);">
					<div id="loadingChat" class="text-center text-white-50 mt-5">
						<i class="fas fa-spinner fa-spin fa-2x"></i>
						<p class="mt-2">Loading messages...</p>
					</div>
					<div id="messagesList">
						<!-- Messages injected via JS -->
					</div>
				</div>

				<!-- Chat Footer -->
				<div class="p-3 bg-dark bg-opacity-25 border-top border-light border-opacity-10">
					<div class="input-group">
						<input type="text" id="chatInput" class="glass-input form-control border-end-0"
							placeholder="Type your message..." onkeypress="if(event.keyCode==13) sendMessage()">
						<button class="glass-btn bg-primary border-start-0" type="button" onclick="sendMessage()">
							<i class="fas fa-paper-plane"></i>
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<style>
	/* Chat Bubbles */
	.msg-bubble {
		max-width: 75%;
		padding: 10px 15px;
		border-radius: 15px;
		margin-bottom: 15px;
		position: relative;
		word-wrap: break-word;
	}

	.msg-sent {
		background: linear-gradient(135deg, var(--glass-primary), #6366f1);
		color: white;
		align-self: flex-end;
		border-bottom-right-radius: 2px;
		margin-left: auto;
	}

	.msg-received {
		background: rgba(255, 255, 255, 0.1);
		color: white;
		align-self: flex-start;
		border-bottom-left-radius: 2px;
		margin-right: auto;
		border: 1px solid rgba(255, 255, 255, 0.05);
	}

	#messagesList {
		display: flex;
		flex-direction: column;
	}
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
	// Config
	const CHAT_VIEW_URL = "/fit_chat_view/";
	const CHAT_SEND_URL = "/fit_chat_send/"; // + msg

	function loadChat() {
		$.ajax({
			url: CHAT_VIEW_URL,
			type: "GET",
			dataType: "json",
			success: function (response) {
				$("#loadingChat").hide();
				const container = $("#messagesList");
				container.empty();

				const data = response.data;
				const toId = response.toid; // user_lid

				// Update header info if available
				if (response.name) $("#chatUserName").text(response.name);
				if (response.photo) $("#chatUserImg").attr("src", response.photo);

				data.forEach(msg => {
					const isSent = (msg.from != toId);
					// Note: Logic from original file: if (from != toId) -> sent? Wait.
					// Original: if (from != toId) -> justify-content-end (Sent)
					// Let's assume standard logic: 'from' is sender ID. If sender != myID, it's received.
					// But here 'toid' seems to be the OTHER person's ID? 
					// Re-reading original: "var user_lid=dat["toid"]; ... if (type != user_lid) ... justify-content-end"
					// This implies if sender is NOT the 'toid' (the partner), then it is ME (Sent).

					const bubbleClass = isSent ? 'msg-sent' : 'msg-received';
					const html = `<div class="msg-bubble ${bubbleClass}">${msg.message}</div>`;
					container.append(html);
				});

				// Auto Scroll
				const body = document.getElementById("msgBody");
				body.scrollTop = body.scrollHeight;
			},
			error: function (err) {
				console.error("Chat load error", err);
			}
		});
	}

	function sendMessage() {
		const input = $("#chatInput");
		const msg = input.val().trim();
		if (!msg) return;

		// Optimistic UI update (optional, but good for UX)
		// $("#messagesList").append(`<div class="msg-bubble msg-sent">${msg}</div>`);
		// $("#msgBody").scrollTop($("#msgBody")[0].scrollHeight);

		$.ajax({
			url: CHAT_SEND_URL + encodeURIComponent(msg),
			type: "GET",
			dataType: "json",
			success: function (response) {
				input.val("");
				loadChat(); // Refresh to sync
			}
		});
	}

	// Auto-refresh
	$(document).ready(function () {
		loadChat();
		setInterval(loadChat, 2000); // 2 seconds poll
	});
</script>
{% endblock %}